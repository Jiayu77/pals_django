<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <!-- bootstrap-table -->
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-table/1.17.1/bootstrap-table.css" rel="stylesheet">

    <!-- font font-awesome -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.14.0/css/all.min.css" rel="stylesheet">

    <title>Pathway Analysis</title>
</head>

<body>
    <div class="container">
        <!-- Nav bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark rounded">
            <a class="navbar-brand" href="#">PALS Viewer by Django</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="{% url 'pals_viewer:index' %}">Pathway </a>
                    </li>
                    <li class="nav-item ">
                        <a class="nav-link" href="{% url 'pals_viewer:gnps_index' %}">GNPS Molecular Family </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'pals_viewer:ms2lda_index' %}">GNPS-MS2LDA </a>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- Nav bar -->
        <div class="row">
            <div class="col-md-12">
                <!-- content -->
                <div class="content">
                    <h1 class="mt-4 mb-4">PALS - Pathway Activity Level Scoring</h1>

                    <h3>Pathway Analysis</h3>
                    <p>Please upload your intensity (example) and annotation (example) CSV files from the sidebar. Next,
                        select the case and control groups, the pathway analysis method as well as the database to use.
                    </p>

                    <!-- pimp setting -->
                    <div class="row">
                        <div class="col-md-12">
                            <h2>1. Please set data source</h2>
                        </div>
                    </div>
                    <!-- fetch data -->

                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <ul class="nav nav-tabs" id="myTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link active" id="by_account_tab" data-toggle="tab" href="#by_account"
                                        role="tab" aria-controls="by_account" aria-selected="true">By Account</a>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link" id="by_upload_file_tab" data-toggle="tab" href="#by_upload_file"
                                        role="tab" aria-controls="by_upload_file" aria-selected="false">Upload File</a>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link" id="by_token_tab" data-toggle="tab" href="#by_token" role="tab"
                                        aria-controls="contact" aria-selected="false">By Token</a>
                                </li>
                            </ul>
                            <div class="tab-content" id="myTabContent">
                                {% csrf_token %}
                                <div class="tab-pane fade show active" id="by_account" role="tabpanel"
                                    aria-labelledby="by_account_tab">

                                    <div class="row">

                                        <div class="col-md-4">
                                            <div class="form-group mt-2"><label>Username</label><input type="text"
                                                    class="form-control" name="username" value=""></div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="form-group mt-2"><label>Analysis ID</label><input type="text"
                                                    class="form-control" name="by_account_analysis_id" value="1321">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group"><label>Password</label><input type="password"
                                                    class="form-control" name="password" value=""></div>
                                        </div>
                                    </div>


                                </div>
                                <div class="tab-pane fade" id="by_upload_file" role="tabpanel"
                                    aria-labelledby="by_upload_file_tab">

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mt-2"><label>Intensity CSV</label><input type="file"
                                                    class="form-control-file" name="int_df" value="1321">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group mt-2"><label>Annotation CSV</label><input type="file"
                                                    class="form-control-file" name="annotation_df" value="1321">
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                <div class="tab-pane fade" id="by_token" role="tabpanel" aria-labelledby="by_token_tab">
                                    <div class="row">

                                        <div class="col-md-4">
                                            <div class="form-group mt-2"><label>Token</label><input type="text"
                                                    class="form-control" name="token" value="{{local_token}}"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-group mt-2"><label>Analysis ID</label><input type="text"
                                                    class="form-control" name="analysis_id" value="1321">
                                            </div>
                                        </div>
                                    </div>



                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- fetch data -->

                    <!-- get data -->
                    <div class="row">
                        <div class="col-md-8"><button class="btn btn-lg btn-primary btn-block mb-2" id="get_data"><span
                                    id="get_data_start">Get Data</span><span id="get_data_running"><span
                                        class="spinner-border spinner-border-lg" role="status"
                                        aria-hidden="true"></span>
                                    Running...</span></button></div>
                    </div>
                    <!-- get data -->

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group"><label>Experimental Design</label><textarea class="form-control"
                                    rows="3" name="experimental_design"></textarea></div>
                        </div>
                    </div>
                    <!-- pimp setting -->


                    <!-- analysis method select -->
                    <div class="row">
                        <div class="col-md-12">
                            <h2>2. Please select analysis method options</h2>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <input type="hidden" name="keypath_int_df_filename">
                            <input type="hidden" name="keypath_annotation_df_filename">
                            <div class="form-group"><label>Pathway Analysis Method</label>
                                <select name="pathway_analysis_method" class="form-control" required="required">
                                    <option>PLAGE</option>
                                    <option>ORA</option>
                                    <option>GSEA</option>
                                </select></div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group"><label>Database</label><select name="database" class="form-control"
                                    required="required">
                                    {% for database in databases %}
                                    <option>{{database}}</option>
                                    {% endfor %}
                                </select></div>
                            <div class="form-group"><label>Reactome Species</label><select name="reactome_species"
                                    class="form-control" required="required">
                                    {% for reactome_specy in reactome_species %}
                                    <option>{{reactome_specy}}</option>
                                    {% endfor %}
                                </select></div>
                            <div class="form-group form-check"><input type="checkbox" class="form-check-input"
                                    name="reactome_metabolic_pathway_only"><label class="form-check-label">Limit to
                                    metabolic pathways only.</label></div>
                            <div class="form-group form-check"><input type="checkbox" class="form-check-input"
                                    name="reactome_query"><label class="form-check-label">Connect to a Reactome Neo4j
                                    database (Online Mode).</label>
                            </div>
                        </div>
                    </div>
                    <!-- submit -->
                    <div class="row">
                        <div class="col-md-8"><button class="btn btn-lg btn-primary btn-block mb-2" id="analysis"><span
                                    id="analysis_start">Start Analysis And Get Results</span><span
                                    id="analysis_running"><span class="spinner-border spinner-border-lg" role="status"
                                        aria-hidden="true"></span> Running...</span></button></div>
                    </div>
                    <!-- submit -->
                    <!-- analysis method select -->

                    <hr>

                    <!-- display result -->
                    <div class="row">
                        <div class="col-md-12">
                            <h2>3. Results</h2>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div id="toolbar" style="margin: 0;"></div>
                            <table class="table table-hover" id="result-table" data-unique-id="header-0"
                                data-toolbar="#toolbar" data-pagination="true" data-search="true"
                                data-show-export="true" data-page-list="[10, 25, 50, 100, all]"></table>
                            <!-- <div class="table-responsive pd-2 rounded">
                            </div> -->
                        </div>
                    </div>
                    <!-- display result -->
                </div>
                <!-- content -->
            </div>
        </div>

    </div>

    <!-- modal detail -->
    <div class="modal fade" tabindex="-1" role="dialog" id="modal-detail">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="modal-detail-content">
                    <h4>map00130: Ubiquinone and other terpenoid-quinone biosynthesis [<a
                            href="https://www.genome.jp/dbget-bin/www_bget?map00130" target="_blank"
                            rel="noopener noreferrer">Info</a>]</h4>
                    <p>p-value: 0.001586</p>
                    <p>Formula Hits: 6</p>
                    <p>Summary:</p>
                    <p>CLASS : Metabolism; Metabolism of cofactors and vitamins</p>
                    <img src="https://www.genome.jp/kegg/pathway/map/map00130.png" class="img-fluid" alt="" srcset="">
                </div>
            </div>
        </div>
    </div>
    <!-- modal detail -->

    <div id="example_message" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true"
        data-autohide="true" data-delay="3000" style="width: 200px;">
        <div class="toast-header">
            <strong class="mr-auto" id="message_type"></strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="toast-body" id="message"></div>
    </div>

    <div aria-live="polite" aria-atomic="true">
        <!-- Position it -->
        <div id="message_list" style="position: fixed; top: 20px; right: 20px;">
            <!-- Then put toasts within -->
        </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous">
    </script>

    <!-- bootstrap-table -->
    <script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/bootstrap-table.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/extensions/export/bootstrap-table-export.min.js">
    </script>

    <script>
        // ---------------- init global parameters ----------------
        let bootstrap_table = null;

        // ---------------- init global parameters ----------------

        // display loading animation
        function display_loading_animation(button_id) {
            let start_icon = button_id + '_start';
            let running_icon = button_id + '_running';
            $(start_icon).hide();
            $(running_icon).show();
            $(button_id).attr("disabled", true);
        }
        // display loading animation

        // remove loading animation
        function remove_loading_animation(button_id) {
            let start_icon = button_id + '_start';
            let running_icon = button_id + '_running';
            $(start_icon).show();
            $(running_icon).hide();
            $(button_id).removeAttr("disabled");
        }
        // remove loading animation

        // show message or error
        function show_message(message_type, content) {
            // set new content
            $("#message_type").text(message_type);
            $("#message").text(content);

            // clone the new message
            let new_toast = $("#example_message").clone();

            // remove ids
            new_toast.removeAttr("id");

            // add new message to message list
            $("#message_list").append(new_toast);

            // show the new message
            new_toast.toast('show');
        }
        // show message or error

        // display details
        function display_detail(index) {
            console.log('display index:', index);

            // get this row data
            let row_header = $('#result-table').bootstrapTable('getRowByUniqueId', index);
            console.log('row header=', row_header)

            // replay row key by real names
            let columns = $('#result-table').bootstrapTable('getVisibleColumns');
            console.log('columns=', columns);
            let column_dict = {};
            columns.forEach(column => {
                column_dict[column["field"]] = column["title"];
            });
            console.log('column dict=', column_dict);

            let row = {}
            for (const key in row_header) {
                const element = row_header[key];
                const new_key = column_dict[key];
                row[new_key] = element;
            }

            // set taget keys
            row["p-value"] = row["beer1/beer2 p-value"];
            row["Formula Hits"] = row["F_coverage"];

            console.log('row=', row);
            let pathway_name = row['pw_name'];
            console.log('pathway_name=', pathway_name);
            let id = index;
            console.log('id=', id);

            // ask for backend data
            // get csrf token
            let csrfmiddlewaretoken = $("[name='csrfmiddlewaretoken']").val();
            // get csrf token

            let data = {
                csrfmiddlewaretoken: csrfmiddlewaretoken,
                row: JSON.stringify(row),
                pathway_name: pathway_name,
                id: id
            };

            let token = $("[name='token']")[0].value;
            let database = $("[name='database']").val();

            let url = ''
            if (database == '{{KEGG}}') {
                url = "{% url 'pals_viewer:show_kegg_diagram' %}"
            } else {
                url = "{% url 'pals_viewer:show_reactome_diagram' %}"
                data['token'] = token;
            }

            // get all inputs, then post and get result
            // if error, just show errors
            // if success, just show tables
            $.ajax({
                url: url,
                type: "POST",
                data: data,
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    let status = data.status;
                    if (status == 'success') {
                        let details = data.data.details;
                        $('#modal-detail-content').html(details);
                        $('#modal-detail').modal('show');
                    } else {
                        let message = data.message;
                        show_message('Error', message);
                    }
                },
                error: function (jqXHR, textStatus, err) {
                    console.log(arguments);
                    remove_loading_animation('#analysis');
                    show_message('Error', err);
                },
                complete: function (jqXHR, textStatus) {
                    console.log(textStatus);
                    remove_loading_animation('#analysis');
                    // show_message('Info', 'Done!');
                },
                statusCode: {
                    '403': function (jqXHR, textStatus, err) {
                        console.log(arguments);
                        remove_loading_animation('#analysis');
                        show_message('Error', err);
                    },
                    '400': function (jqXHR, textStatus, err) {
                        console.log(arguments);
                        remove_loading_animation('#analysis');
                        show_message('Error', err);
                    }
                }
            });
        }
        // display details

        // display single row detail
        function operateFormatter(value, row, index) {
            console.log('index', index, 'row=', row);
            return [
                '<a class="view" href="javascript:void(0)" onclick="display_detail(\'' + row["header-0"] +
                '\')" title="View">',
                // '<a class="view" href="javascript:void(0)" onclick="display_detail(\''+row["header-0"]+'\')" title="View">',
                '<i class="fa fa-eye"></i>',
                ' ',
                value,
                '</a>  ',
            ].join('')
        }
        // display single row detail

        // display table
        function display_table(headers, rows) {

            // clean old table
            let result_table = $("#result-table");
            result_table.empty();

            // add header config
            // make each column sortable
            // column config example:
            // [{
            //     title: 'Item ID',
            //     field: 'id',
            //     rowspan: 2,
            //     align: 'center',
            //     valign: 'middle',
            //     sortable: true,
            //     footerFormatter: totalTextFormatter
            // }]
            headers[0] = "id";
            let columns = new Array();
            for (let i = 0; i < headers.length; i++) {
                const element = headers[i];

                let column = {
                    "title": element,
                    "field": "header-" + i,
                    "sortable": true,
                };

                if (i == 1) {
                    column["formatter"] = operateFormatter
                }
                columns.push(column);
            }

            // make table data
            data = [];
            rows.forEach(row => {
                let tr = {};
                for (let i = 0; i < row.length; i++) {
                    tr["header-" + i] = row[i];
                }
                data.push(tr);
            });

            // init table
            bootstrap_table = result_table.bootstrapTable('destroy').bootstrapTable({
                showExport: true,
                exportDataType: "all",
                exportTypes: ['json', 'csv', 'txt'],
                columns: columns,
                data: data
            })
        }
        // display table

        // load keypath data from localstorage
        function load_keypath_data_from_local() {
            let keypath_int_df = localStorage.getItem("keypath_int_df");
            let keypath_annotation_df = localStorage.getItem("keypath_annotation_df");
            let keypath_experimental_design = localStorage.getItem("keypath_experimental_design");

            if (keypath_int_df != null) {
                keypath_int_df = JSON.parse(keypath_int_df);
                console.log('read keypath int df:', keypath_int_df);

                $("[name='keypath_int_df_filename']").val(keypath_int_df.filename);
            }

            if (keypath_annotation_df != null) {
                keypath_annotation_df = JSON.parse(keypath_annotation_df);
                console.log('read keypath annotation df:', keypath_annotation_df);
                $("[name='keypath_annotation_df_filename']").val(keypath_annotation_df.filename);
            }

            if (keypath_experimental_design != null) {
                // keypath_experimental_design = JSON.parse(keypath_experimental_design);
                console.log('read keypath annotation df:', keypath_experimental_design);
                $("[name='experimental_design']").val(keypath_experimental_design);
            }
        }
        // load keypath data from localstorage

        // 1. at first, we need to set the button to correct status
        remove_loading_animation('#analysis');
        remove_loading_animation('#get_data');

        // loading localStorage cache data
        load_keypath_data_from_local();

        // 2. binding the click event to button
        //    if click the button, we need to submit data
        $('#analysis').click(function () {
            // display loading animation
            display_loading_animation('#analysis');

            // get all inputs, then post and get result
            // let token = $("[name='token']")[0].value;
            // let analysis_id = $("[name='analysis_id']")[0].value;
            let keypath_int_df_filename = $("[name='keypath_int_df_filename']").val();
            let keypath_annotation_df_filename = $("[name='keypath_annotation_df_filename']").val();
            let experimental_design = $("[name='experimental_design']")[0].value;
            let pathway_analysis_method = $("[name='pathway_analysis_method']").val();
            let database = $("[name='database']").val();
            let reactome_species = $("[name='reactome_species']").val();
            let reactome_metabolic_pathway_only = false;
            if ($("[name='reactome_metabolic_pathway_only']").is(':checked')) {
                reactome_metabolic_pathway_only = true;
            }
            let reactome_query = false;
            if ($("[name='reactome_query']").is(':checked')) {
                reactome_query = true;
            }

            // get csrf token
            let csrfmiddlewaretoken = $("[name='csrfmiddlewaretoken']").val();
            // get csrf token

            // debug
            window.console.log('keypath_int_df_filename=', keypath_int_df_filename)
            window.console.log('keypath_annotation_df_filename=', keypath_annotation_df_filename)
            window.console.log('experimental_design=', experimental_design)
            window.console.log('pathway_analysis_method=', pathway_analysis_method)
            window.console.log('database=', database)
            window.console.log('reactome_species=', reactome_species)
            window.console.log('reactome_metabolic_pathway_only=', reactome_metabolic_pathway_only)
            window.console.log('reactome_query=', reactome_query)
            // debug
            let data = {
                csrfmiddlewaretoken: csrfmiddlewaretoken,
                keypath_int_df_filename: keypath_int_df_filename,
                keypath_annotation_df_filename: keypath_annotation_df_filename,
                experimental_design: experimental_design,
                pathway_analysis_method: pathway_analysis_method,
                database: database,
                reactome_species: reactome_species,
                reactome_metabolic_pathway_only: reactome_metabolic_pathway_only,
                reactome_query: reactome_query
            };

            // get all inputs, then post and get result
            // if error, just show errors
            // if success, just show tables
            $.ajax({
                url: "analysis",
                type: "POST",
                data: data,
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    let table = data.data.table;
                    let headers = table.headers;
                    let rows = table.rows;
                    display_table(headers, rows);
                    remove_loading_animation('#analysis');
                    show_message('Info', data.message);
                },
                error: function (jqXHR, textStatus, err) {
                    console.log(arguments);
                    remove_loading_animation('#analysis');
                    show_message('Error', err);
                },
                complete: function (jqXHR, textStatus) {
                    console.log(textStatus);
                    remove_loading_animation('#analysis');
                    // show_message('Info', 'Done!');
                },
                statusCode: {
                    '403': function (jqXHR, textStatus, err) {
                        console.log(arguments);
                        remove_loading_animation('#analysis');
                        show_message('Error', err);
                    },
                    '400': function (jqXHR, textStatus, err) {
                        console.log(arguments);
                        remove_loading_animation('#analysis');
                        show_message('Error', err);
                    }
                }
            });
        });

        // 3. binding the click event to button
        //    if click the button, we need to get data from remote
        $('#get_data').click(function () {
            // display loading animation
            display_loading_animation('#get_data');

            let data_type = 'token';

            // get all inputs, then post and get result
            let token = $("[name='token']")[0].value;
            let analysis_id = $("[name='analysis_id']")[0].value;

            let username = $("[name='username']")[0].value;
            let password = $("[name='password']")[0].value;
            let by_account_analysis_id = $("[name='by_account_analysis_id']")[0].value;

            let int_csv = $("[name='int_df']")[0].files[0];
            let annotation_csv = $("[name='annotation_df']")[0].files[0];

            // get csrf token
            let csrfmiddlewaretoken = $("[name='csrfmiddlewaretoken']").val();
            // get csrf token

            // get active tab
            if ($("#by_token").hasClass("active")) {
                data_type = 'token';
            } else if ($("#by_account").hasClass("active")) {
                data_type = 'account';
            } else {
                data_type = 'upload_file';
            }
            console.log("get data by type: " + data_type);

            // debug
            window.console.log('token=', token)
            window.console.log('analysis_id=', analysis_id)
            window.console.log('data_type=', data_type)
            // debug
            let data = {};
            if (data_type == 'upload_file') {
                data = new FormData();
                data.append('csrfmiddlewaretoken', csrfmiddlewaretoken);
                data.append('token', token);
                data.append('analysis_id', analysis_id);
                data.append('username', username);
                data.append('password', password);
                data.append('by_account_analysis_id', by_account_analysis_id);
                data.append('int_csv', int_csv);
                data.append('annotation_csv', annotation_csv);
                data.append('data_type', data_type);
            } else {
                data = {
                    csrfmiddlewaretoken: csrfmiddlewaretoken,
                    token: token,
                    analysis_id: analysis_id,
                    username: username,
                    password: password,
                    by_account_analysis_id: by_account_analysis_id,
                    int_csv: int_csv,
                    annotation_csv: annotation_csv,
                    data_type: data_type,
                };
            }

            // get all inputs, then post and get result
            // if error, just show errors
            // if success, just show tables
            $.ajax({
                url: "{% url 'pals_viewer:keypath_get_data' %}",
                type: "POST",
                data: data,
                dataType: "json",
                processData: false, // required for file uploading
                contentType: false, // required for file uploading
                success: function (data) {
                    console.log(data);
                    let status = data.status;

                    if (status == 'success') {
                        // debug
                        remove_loading_animation('#get_data');
                        show_message('Info', data.message);
                        // debug

                        // save data to local
                        let int_df = data.data.int_df;
                        let annotation_df = data.data.annotation_df;
                        let experimental_design = data.data.experimental_design;
                        localStorage.setItem("keypath_int_df", JSON.stringify(int_df));
                        localStorage.setItem("keypath_annotation_df", JSON.stringify(
                            annotation_df));
                        localStorage.setItem("keypath_experimental_design", JSON.stringify(
                            experimental_design));
                        console.log('save int_df and annotation_df to local...');

                        // load data to page
                        load_keypath_data_from_local();

                        remove_loading_animation('#get_data');
                        show_message('Info', data.message);
                    } else {
                        remove_loading_animation('#get_data');
                        show_message('Error', data.message);
                    }
                },
                error: function (jqXHR, textStatus, err) {
                    console.log(arguments);
                    remove_loading_animation('#get_data');
                    show_message('Error', err);
                },
                complete: function (jqXHR, textStatus) {
                    console.log(textStatus);
                    remove_loading_animation('#get_data');
                    // show_message('Info', 'Done!');
                },
                statusCode: {
                    '403': function (jqXHR, textStatus, err) {
                        console.log(arguments);
                        remove_loading_animation('#get_data');
                        show_message('Error', err);
                    },
                    '400': function (jqXHR, textStatus, err) {
                        console.log(arguments);
                        remove_loading_animation('#get_data');
                        show_message('Error', err);
                    }
                }
            });
        });

    </script>
</body>

</html>
