<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    
    <!-- bootstrap-table -->
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-table/1.17.1/bootstrap-table.css" rel="stylesheet">

    <title>Pathway Analysis</title>
</head>

<body>
    <div class="container">
        <!-- Nav bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark rounded">
            <a class="navbar-brand" href="#">PALS Viewer by Django</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">

                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'pals_viewer:index' %}">Pathway </a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="{% url 'pals_viewer:gnps_index' %}">GNPS Molecular Family </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'pals_viewer:ms2lda_index' %}">GNPS-MS2LDA </a>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- Nav bar -->
        <div class="row">
            <div class="col-md-12">
                <!-- content -->
                <div class="content">
                    <h1 class="mt-4 mb-4">PALS - Pathway Activity Level Scoring</h1>

                    <h3>GNPS Molecular Family</h3>
                    <p>Please upload your intensity (example) and annotation (example) CSV files from the sidebar. Next,
                        select the case and control groups, the pathway analysis method as well as the database to use.
                    </p>

                    <!-- pimp setting -->
                    <div class="row">
                        <div class="col-md-12">
                            <h2>1. Please set data source</h2>
                        </div>
                    </div>
                    <div class="row">
                        {% csrf_token %}
                        <div class="col-md-4">
                            <div class="form-group"><label>GNPS database url</label><input type="text" class="form-control" name="gnps_url" value=""></div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group"><label>Metadata</label><input type="file" class="form-control-file" name="metadata" value="1321">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group"><label>Experimental Design</label><textarea class="form-control"
                                    rows="3" name="experimental_design"></textarea></div>
                        </div>
                    </div>
                    <!-- pimp setting -->

                    <!-- analysis method select -->
                    <div class="row">
                        <div class="col-md-12">
                            <h2>2. Please select analysis method options</h2>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group"><label>Pathway Analysis Method</label>
                                <select name="pathway_analysis_method" class="form-control" required="required">
                                    <option>PLAGE</option>
                                    <option>ORA</option>
                                    <option>GSEA</option>
                                </select></div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group"><label>Database</label><select name="database" class="form-control"
                                    required="required">
                                    {% for database in databases %}
                                    <option>{{database}}</option>
                                    {% endfor %}
                                </select></div>
                            <div class="form-group"><label>Reactome Species</label><select name="reactome_species"
                                    class="form-control" required="required">
                                    {% for reactome_specy in reactome_species %}
                                    <option>{{reactome_specy}}</option>
                                    {% endfor %}
                                </select></div>
                            <div class="form-group form-check"><input type="checkbox" class="form-check-input"
                                    name="reactome_metabolic_pathway_only"><label class="form-check-label">Limit to
                                    metabolic pathways only.</label></div>
                            <div class="form-group form-check"><input type="checkbox" class="form-check-input"
                                    name="reactome_query"><label class="form-check-label">Connect to a Reactome Neo4j
                                    database (Online Mode).</label>
                            </div>
                        </div>
                    </div>
                    <!-- submit -->
                    <div class="row">
                        <div class="col-md-8"><button class="btn btn-lg btn-primary btn-block mb-2"
                                id="start_analysis"><span id="start_status">Start Analysis And Get Results</span><span id="running_status"><span class="spinner-border spinner-border-lg" role="status" aria-hidden="true"></span> Running...</span></button></div>
                    </div>
                    <!-- submit -->
                    <!-- analysis method select -->

                    <hr>

                    <!-- display result -->
                    <div class="row">
                        <div class="col-md-12">
                            <h2>3. Results</h2>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div id="toolbar" style="margin: 0;"></div>
                            <table class="table table-hover" id="result-table"
                                data-toolbar="#toolbar"
                                data-pagination="true"
                                data-search="true"
                                data-show-export="true"
                                data-page-list="[10, 25, 50, 100, all]"
                            ></table>
                            <!-- <div class="table-responsive pd-2 rounded">
                            </div> -->
                        </div>
                    </div>
                    <!-- display result -->
                </div>
                <!-- content -->
            </div>
        </div>

    </div>

    <div id="example_message" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="true" data-delay="3000" style="width: 200px;" >
    <div class="toast-header">
        <strong class="mr-auto" id="message_type"></strong>
        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
        <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="toast-body" id="message"></div>
    </div>

    <div aria-live="polite" aria-atomic="true">
        <!-- Position it -->
        <div id="message_list"  style="position: fixed; top: 20px; right: 20px;">
          <!-- Then put toasts within -->
        </div>
      </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous">
    </script>

    <!-- bootstrap-table -->
    <script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/bootstrap-table.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.17.1/dist/extensions/export/bootstrap-table-export.min.js"></script>

    <script>
        // display loading animation
        function display_loading_animation() {
            $("#start_status").hide();
            $("#running_status").show();
            $("#start_analysis").attr("disabled", true);
        }
        // display loading animation

        // remove loading animation
        function remove_loading_animation() {
            $("#start_status").show();
            $("#running_status").hide();
            $("#start_analysis").removeAttr("disabled");
        }
        // remove loading animation

        // show message or error
        function show_message(message_type, content) {
            // set new content
            $("#message_type").text(message_type);
            $("#message").text(content);

            // clone the new message
            let new_toast = $("#example_message").clone();

            // remove ids
            new_toast.removeAttr("id");

            // add new message to message list
            $("#message_list").append(new_toast);

            // show the new message
            new_toast.toast('show');
        }
        // show message or error

        // display table
        function display_table(headers, rows) {

            // clean old table
            let result_table = $("#result-table");
            result_table.empty();

            // add header config
            // make each column sortable
            // column config example:
            // [{
            //     title: 'Item ID',
            //     field: 'id',
            //     rowspan: 2,
            //     align: 'center',
            //     valign: 'middle',
            //     sortable: true,
            //     footerFormatter: totalTextFormatter
            // }]
            headers[0] = "id";
            let columns = new Array();
            for (let i = 0; i < headers.length; i++) {
                const element = headers[i];
                let column = {
                    "title": element,
                    "field": "header-"+i,
                    "sortable": true
                };
                columns.push(column);
            }

            // make table data
            data = [];
            rows.forEach(row => {
                let tr = {};
                for (let i=0;i<row.length;i++)
                {
                    tr["header-"+i] = row[i];
                }
                data.push(tr);
            });

            // init table
            result_table.bootstrapTable('destroy').bootstrapTable({
                showExport: true,
                exportDataType: "all",
                exportTypes: ['json', 'csv', 'txt'],
                columns: columns,
                data: data
            })
        }
        // display table

        // 1. at first, we need to set the button to correct status
        remove_loading_animation();

        // 2. binding the click event to button
        //    if click the button, we need to submit data
        $('#start_analysis').click(function () {
            // display loading animation
            display_loading_animation();

            // get all inputs, then post and get result
            let token = $("[name='token']")[0].value;
            let analysis_id = $("[name='analysis_id']")[0].value;
            let experimental_design = $("[name='experimental_design']")[0].value;
            let pathway_analysis_method = $("[name='pathway_analysis_method']").val();
            let database = $("[name='database']").val();
            let reactome_species = $("[name='reactome_species']").val();
            let reactome_metabolic_pathway_only = false;
            if ($("[name='reactome_metabolic_pathway_only']").is(':checked')) {
                reactome_metabolic_pathway_only = true;
            }
            let reactome_query = false;
            if ($("[name='reactome_query']").is(':checked')) {
                reactome_query = true;
            }

            // get csrf token
            let csrfmiddlewaretoken = $("[name='csrfmiddlewaretoken']").val();
            // get csrf token

            // debug
            window.console.log('token=', token)
            window.console.log('analysis_id=', analysis_id)
            window.console.log('experimental_design=', experimental_design)
            window.console.log('pathway_analysis_method=', pathway_analysis_method)
            window.console.log('database=', database)
            window.console.log('reactome_species=', reactome_species)
            window.console.log('reactome_metabolic_pathway_only=', reactome_metabolic_pathway_only)
            window.console.log('reactome_query=', reactome_query)
            // debug
            let data = {
                csrfmiddlewaretoken: csrfmiddlewaretoken,
                token: token,
                analysis_id: analysis_id,
                experimental_design: experimental_design,
                pathway_analysis_method: pathway_analysis_method,
                database: database,
                reactome_species: reactome_species,
                reactome_metabolic_pathway_only: reactome_metabolic_pathway_only,
                reactome_query: reactome_query
            };

            // get all inputs, then post and get result
            // if error, just show errors
            // if success, just show tables
            $.ajax({
                url: "analysis",
                type: "POST",
                data: data,
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    let table = data.data.table;
                    let headers = table.headers;
                    let rows = table.rows;
                    display_table(headers, rows);
                    remove_loading_animation();
                    show_message('Info', data.message);
                },
                error: function (jqXHR, textStatus, err) {
                    console.log(arguments);
                    remove_loading_animation();
                    show_message('Error', err);
                },
                complete: function (jqXHR, textStatus) {
                    console.log(textStatus);
                    remove_loading_animation();
                    // show_message('Info', 'Done!');
                },
                statusCode: {
                    '403': function (jqXHR, textStatus, err) {
                        console.log(arguments);
                        remove_loading_animation();
                        show_message('Error', err);
                    },
                    '400': function (jqXHR, textStatus, err) {
                        console.log(arguments);
                        remove_loading_animation();
                        show_message('Error', err);
                    }
                }
            });
        });

    </script>
</body>

</html>
